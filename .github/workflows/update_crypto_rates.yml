name: Update Crypto Rates

on:
  schedule:
    # 每天 UTC 00:00 執行（與法幣相同時間）
    - cron: '0 0 * * *'

  # 手動觸發
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  fetch-crypto-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create docs directory
        run: mkdir -p docs

      - name: Fetch Crypto Rates with Triple Fallback
        id: fetch
        run: |
          CRYPTO_IDS="bitcoin,ethereum,tether,binancecoin,solana,ripple,usd-coin,cardano,dogecoin,tron,matic-network,litecoin,polkadot,chainlink,avalanche-2"

          # API 1: CoinGecko Simple Price（主要來源）
          echo "嘗試 CoinGecko API..."
          if curl -f -s --max-time 15 --retry 2 --retry-delay 3 \
            "https://api.coingecko.com/api/v3/simple/price?ids=${CRYPTO_IDS}&vs_currencies=usd" \
            > temp_crypto.json; then

            if jq -e '.bitcoin.usd' temp_crypto.json >/dev/null 2>&1; then
              echo "✅ CoinGecko API 成功"
              echo "source=coingecko" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # API 2: CryptoCompare（備援）
          echo "CoinGecko 失敗，嘗試 CryptoCompare..."
          SYMBOLS="BTC,ETH,USDT,BNB,SOL,XRP,USDC,ADA,DOGE,TRX,MATIC,LTC,DOT,LINK,AVAX"
          if curl -f -s --max-time 15 --retry 2 --retry-delay 3 \
            "https://min-api.cryptocompare.com/data/pricemulti?fsyms=${SYMBOLS}&tsyms=USD" \
            > temp_crypto.json; then

            if jq -e '.BTC.USD' temp_crypto.json >/dev/null 2>&1; then
              echo "✅ CryptoCompare API 成功"
              echo "source=cryptocompare" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # API 3: Binance（備援）
          echo "CryptoCompare 失敗，嘗試 Binance..."
          BINANCE_SYMBOLS='["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","TRXUSDT","MATICUSDT","LTCUSDT","DOTUSDT","LINKUSDT","AVAXUSDT"]'
          if curl -f -s --max-time 15 --retry 2 --retry-delay 3 \
            "https://api.binance.com/api/v3/ticker/price?symbols=${BINANCE_SYMBOLS}" \
            > temp_crypto.json; then

            if jq -e '.[0].price' temp_crypto.json >/dev/null 2>&1; then
              echo "✅ Binance API 成功"
              echo "source=binance" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "❌ 所有 API 都失敗"
          exit 1

      - name: Transform to Unified Format
        if: success()
        run: |
          SOURCE="${{ steps.fetch.outputs.source }}"
          TIMESTAMP=$(date -u +"%a, %d %b %Y")

          if [[ "$SOURCE" == "coingecko" ]]; then
            # CoinGecko 格式轉換
            cat temp_crypto.json | jq --arg date "$TIMESTAMP" '{
              base: "USD",
              date: $date,
              rates: {
                BTC: .bitcoin.usd,
                ETH: .ethereum.usd,
                USDT: .tether.usd,
                BNB: .binancecoin.usd,
                SOL: .solana.usd,
                XRP: .ripple.usd,
                USDC: ."usd-coin".usd,
                ADA: .cardano.usd,
                DOGE: .dogecoin.usd,
                TRX: .tron.usd,
                MATIC: ."matic-network".usd,
                LTC: .litecoin.usd,
                DOT: .polkadot.usd,
                LINK: .chainlink.usd,
                AVAX: ."avalanche-2".usd
              }
            }' > docs/crypto-rates.json

          elif [[ "$SOURCE" == "cryptocompare" ]]; then
            # CryptoCompare 格式（直接使用符號）
            cat temp_crypto.json | jq --arg date "$TIMESTAMP" '{
              base: "USD",
              date: $date,
              rates: {
                BTC: .BTC.USD,
                ETH: .ETH.USD,
                USDT: .USDT.USD,
                BNB: .BNB.USD,
                SOL: .SOL.USD,
                XRP: .XRP.USD,
                USDC: .USDC.USD,
                ADA: .ADA.USD,
                DOGE: .DOGE.USD,
                TRX: .TRX.USD,
                MATIC: .MATIC.USD,
                LTC: .LTC.USD,
                DOT: .DOT.USD,
                LINK: .LINK.USD,
                AVAX: .AVAX.USD
              }
            }' > docs/crypto-rates.json

          elif [[ "$SOURCE" == "binance" ]]; then
            # Binance 格式（需要提取符號）
            cat temp_crypto.json | jq --arg date "$TIMESTAMP" '{
              base: "USD",
              date: $date,
              rates: (
                reduce .[] as $item ({};
                  . + {
                    ($item.symbol | sub("USDT$"; "")): ($item.price | tonumber)
                  }
                )
              )
            }' > docs/crypto-rates.json
          fi

          rm temp_crypto.json

          # 驗證關鍵幣種
          for coin in BTC ETH USDT; do
            if grep -q "\"$coin\"" docs/crypto-rates.json; then
              echo "✓ $coin 已確認"
            fi
          done

      - name: Commit and Push
        if: success()
        run: |
          git config --global user.name "Coinflow Crypto Bot"
          git config --global user.email "crypto@coinflow.bot"

          if [[ -n $(git status -s docs/crypto-rates.json) ]]; then
            git add docs/crypto-rates.json
            git commit -m "Update crypto rates (Source: ${{ steps.fetch.outputs.source }}) [skip ci]"
            git push
            echo "✅ 加密貨幣匯率已更新"
          else
            echo "ℹ️ 加密貨幣匯率無變化"
          fi

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `⚠️ 加密貨幣匯率更新失敗 (${now})`,
              body: `所有加密貨幣 API 都失敗了：\n\n1. CoinGecko\n2. CryptoCompare\n3. Binance\n\n時間：${now}`,
              labels: ['bug', 'crypto', 'automated']
            });
