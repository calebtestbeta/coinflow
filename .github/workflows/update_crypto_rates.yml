name: Update Crypto Rates

on:
  schedule:
    # 每天 UTC 00:00 執行（與法幣相同時間）
    - cron: '0 0 * * *'

  # 手動觸發
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  fetch-crypto-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create docs directory
        run: mkdir -p docs

      - name: Fetch Crypto Rates with Triple Fallback
        id: fetch
        run: |
          CRYPTO_IDS="bitcoin,ethereum,tether,binancecoin,solana,ripple,usd-coin,cardano,dogecoin,tron,matic-network,litecoin,polkadot,chainlink,avalanche-2"

          # API 1: CoinGecko Simple Price（主要來源）
          echo "嘗試 CoinGecko API..."
          if curl -f -s --max-time 15 --retry 2 --retry-delay 3 \
            "https://api.coingecko.com/api/v3/simple/price?ids=${CRYPTO_IDS}&vs_currencies=usd" \
            > temp_crypto.json; then

            if jq -e '.bitcoin.usd' temp_crypto.json >/dev/null 2>&1; then
              echo "✅ CoinGecko API 成功"
              echo "source=coingecko" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # API 2: CryptoCompare（備援）
          echo "CoinGecko 失敗，嘗試 CryptoCompare..."
          SYMBOLS="BTC,ETH,USDT,BNB,SOL,XRP,USDC,ADA,DOGE,TRX,MATIC,LTC,DOT,LINK,AVAX"
          if curl -f -s --max-time 15 --retry 2 --retry-delay 3 \
            "https://min-api.cryptocompare.com/data/pricemulti?fsyms=${SYMBOLS}&tsyms=USD" \
            > temp_crypto.json; then

            if jq -e '.BTC.USD' temp_crypto.json >/dev/null 2>&1; then
              echo "✅ CryptoCompare API 成功"
              echo "source=cryptocompare" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # API 3: Binance（備援）
          echo "CryptoCompare 失敗，嘗試 Binance..."
          BINANCE_SYMBOLS='["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","TRXUSDT","MATICUSDT","LTCUSDT","DOTUSDT","LINKUSDT","AVAXUSDT"]'
          if curl -f -s --max-time 15 --retry 2 --retry-delay 3 \
            "https://api.binance.com/api/v3/ticker/price?symbols=${BINANCE_SYMBOLS}" \
            > temp_crypto.json; then

            if jq -e '.[0].price' temp_crypto.json >/dev/null 2>&1; then
              echo "✅ Binance API 成功"
              echo "source=binance" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "❌ 所有 API 都失敗"
          exit 1

      - name: Transform to Unified Format
        if: success()
        run: |
          SOURCE="${{ steps.fetch.outputs.source }}"
          TIMESTAMP=$(date -u +"%a, %d %b %Y")

          if [[ "$SOURCE" == "coingecko" ]]; then
            # CoinGecko 格式轉換
            # 重要：將價格轉換為 "1 USD = X crypto" 格式（取倒數）以匹配法幣格式
            cat temp_crypto.json | jq --arg date "$TIMESTAMP" '{
              base: "USD",
              date: $date,
              rates: {
                BTC: (if (.bitcoin.usd // 0) > 0 then 1 / .bitcoin.usd else 0 end),
                ETH: (if (.ethereum.usd // 0) > 0 then 1 / .ethereum.usd else 0 end),
                USDT: (if (.tether.usd // 1) > 0 then 1 / .tether.usd else 1 end),
                BNB: (if (.binancecoin.usd // 0) > 0 then 1 / .binancecoin.usd else 0 end),
                SOL: (if (.solana.usd // 0) > 0 then 1 / .solana.usd else 0 end),
                XRP: (if (.ripple.usd // 0) > 0 then 1 / .ripple.usd else 0 end),
                USDC: (if (."usd-coin".usd // 1) > 0 then 1 / ."usd-coin".usd else 1 end),
                ADA: (if (.cardano.usd // 0) > 0 then 1 / .cardano.usd else 0 end),
                DOGE: (if (.dogecoin.usd // 0) > 0 then 1 / .dogecoin.usd else 0 end),
                TRX: (if (.tron.usd // 0) > 0 then 1 / .tron.usd else 0 end),
                MATIC: (if (."matic-network".usd // 0) > 0 then 1 / ."matic-network".usd else 0 end),
                LTC: (if (.litecoin.usd // 0) > 0 then 1 / .litecoin.usd else 0 end),
                DOT: (if (.polkadot.usd // 0) > 0 then 1 / .polkadot.usd else 0 end),
                LINK: (if (.chainlink.usd // 0) > 0 then 1 / .chainlink.usd else 0 end),
                AVAX: (if (."avalanche-2".usd // 0) > 0 then 1 / ."avalanche-2".usd else 0 end)
              }
            }' > docs/crypto-rates.json

          elif [[ "$SOURCE" == "cryptocompare" ]]; then
            # CryptoCompare 格式（轉換為 "1 USD = X crypto" 格式）
            cat temp_crypto.json | jq --arg date "$TIMESTAMP" '{
              base: "USD",
              date: $date,
              rates: {
                BTC: (if (.BTC.USD // 0) > 0 then 1 / .BTC.USD else 0 end),
                ETH: (if (.ETH.USD // 0) > 0 then 1 / .ETH.USD else 0 end),
                USDT: (if (.USDT.USD // 1) > 0 then 1 / .USDT.USD else 1 end),
                BNB: (if (.BNB.USD // 0) > 0 then 1 / .BNB.USD else 0 end),
                SOL: (if (.SOL.USD // 0) > 0 then 1 / .SOL.USD else 0 end),
                XRP: (if (.XRP.USD // 0) > 0 then 1 / .XRP.USD else 0 end),
                USDC: (if (.USDC.USD // 1) > 0 then 1 / .USDC.USD else 1 end),
                ADA: (if (.ADA.USD // 0) > 0 then 1 / .ADA.USD else 0 end),
                DOGE: (if (.DOGE.USD // 0) > 0 then 1 / .DOGE.USD else 0 end),
                TRX: (if (.TRX.USD // 0) > 0 then 1 / .TRX.USD else 0 end),
                MATIC: (if (.MATIC.USD // 0) > 0 then 1 / .MATIC.USD else 0 end),
                LTC: (if (.LTC.USD // 0) > 0 then 1 / .LTC.USD else 0 end),
                DOT: (if (.DOT.USD // 0) > 0 then 1 / .DOT.USD else 0 end),
                LINK: (if (.LINK.USD // 0) > 0 then 1 / .LINK.USD else 0 end),
                AVAX: (if (.AVAX.USD // 0) > 0 then 1 / .AVAX.USD else 0 end)
              }
            }' > docs/crypto-rates.json

          elif [[ "$SOURCE" == "binance" ]]; then
            # Binance 格式（轉換為 "1 USD = X crypto" 格式）
            cat temp_crypto.json | jq --arg date "$TIMESTAMP" '{
              base: "USD",
              date: $date,
              rates: (
                reduce .[] as $item ({};
                  . + {
                    ($item.symbol | sub("USDT$"; "")): (
                      if (($item.price | tonumber) > 0)
                      then 1 / ($item.price | tonumber)
                      else 0
                      end
                    )
                  }
                )
              )
            }' > docs/crypto-rates.json
          fi

          rm temp_crypto.json

          # 驗證關鍵幣種
          for coin in BTC ETH USDT; do
            if grep -q "\"$coin\"" docs/crypto-rates.json; then
              echo "✓ $coin 已確認"
            fi
          done

      - name: Commit and Push
        if: success()
        run: |
          git config --global user.name "Coinflow Crypto Bot"
          git config --global user.email "crypto@coinflow.bot"

          if [[ -n $(git status -s docs/crypto-rates.json) ]]; then
            git add docs/crypto-rates.json
            git commit -m "Update crypto rates (Source: ${{ steps.fetch.outputs.source }}) [skip ci]"
            git push
            echo "✅ 加密貨幣匯率已更新"
          else
            echo "ℹ️ 加密貨幣匯率無變化"
          fi

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `⚠️ 加密貨幣匯率更新失敗 (${now})`,
              body: `所有加密貨幣 API 都失敗了：\n\n1. CoinGecko\n2. CryptoCompare\n3. Binance\n\n時間：${now}`,
              labels: ['bug', 'crypto', 'automated']
            });
