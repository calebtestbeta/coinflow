name: Deploy and Update Rates

on:
  push:
    branches:
      - main
  schedule:
    # æ¯å¤© UTC æ™‚é–“ 00:00 (å°ç£æ™‚é–“æ—©ä¸Š 08:00) åŸ·è¡Œä¸€æ¬¡
    - cron: '0 0 * * *'
  # å…è¨±æ‰‹å‹•æŒ‰æŒ‰éˆ•è§¸ç™¼ (æ–¹ä¾¿æ¸¬è©¦)
  workflow_dispatch:
    inputs:
      update_rates:
        description: 'æ˜¯å¦æ›´æ–°åŒ¯ç‡ï¼Ÿ'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  issues: write    # éœ€è¦å»ºç«‹ Issue çš„æ¬Šé™
  pages: write     # éƒ¨ç½² GitHub Pages çš„æ¬Šé™
  id-token: write  # OIDC token æ¬Šé™

jobs:
  fetch-update-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Determine if should update rates
        id: check
        run: |
          # Cron è§¸ç™¼ï¼šä¸€å®šæ›´æ–°
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "ğŸ“… å®šæ™‚è§¸ç™¼ï¼šå°‡æ›´æ–°åŒ¯ç‡"

          # æ‰‹å‹•è§¸ç™¼ï¼šçœ‹ç”¨æˆ¶é¸æ“‡
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_update=${{ inputs.update_rates }}" >> $GITHUB_OUTPUT
            echo "ğŸ‘† æ‰‹å‹•è§¸ç™¼ï¼šæ›´æ–°åŒ¯ç‡ = ${{ inputs.update_rates }}"

          # Push è§¸ç™¼ï¼šä¸æ›´æ–°
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ ç¨‹å¼ç¢¼ Pushï¼šè·³éåŒ¯ç‡æ›´æ–°ï¼Œåƒ…éƒ¨ç½²"
          fi

      - name: Create docs directory if not exists
        if: steps.check.outputs.should_update == 'true'
        run: mkdir -p docs

      - name: Fetch Rates with Fallback
        if: steps.check.outputs.should_update == 'true'
        id: fetch
        run: |
          # API 1: open.er-api.comï¼ˆç•¶å‰ä½¿ç”¨ï¼‰
          echo "å˜—è©¦ API 1: open.er-api.com..."
          if curl -f -s --max-time 10 --retry 2 --retry-delay 2 \
            "https://open.er-api.com/v6/latest/USD" > temp_rates.json; then

            if jq -e '.base_code and .rates' temp_rates.json >/dev/null 2>&1; then
              echo "âœ… API 1 æˆåŠŸ"
              echo "source=open.er-api.com" >> $GITHUB_OUTPUT
              echo "format=openexchange" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # API 2: fawazahmed0 CDNï¼ˆå‚™æ´ï¼‰
          echo "API 1 å¤±æ•—ï¼Œå˜—è©¦ API 2: fawazahmed0 CDN..."
          if curl -f -s --max-time 10 --retry 2 --retry-delay 2 \
            "https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json" > temp_rates.json; then

            if jq -e '.date and .usd' temp_rates.json >/dev/null 2>&1; then
              echo "âœ… API 2 æˆåŠŸ"
              echo "source=fawazahmed0" >> $GITHUB_OUTPUT
              echo "format=fawaz" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # æ‰€æœ‰ API éƒ½å¤±æ•—
          echo "âŒ æ‰€æœ‰ API éƒ½å¤±æ•—"
          exit 1

      - name: Transform Data
        if: steps.check.outputs.should_update == 'true' && success()
        run: |
          source=${{ steps.fetch.outputs.source }}
          format=${{ steps.fetch.outputs.format }}

          if [[ "$format" == "openexchange" ]]; then
            # open.er-api.com æ ¼å¼è½‰æ›
            cat temp_rates.json | jq '{
              base: .base_code,
              date: .time_last_update_utc[0:16],
              rates: .rates
            }' > docs/rates.json

          elif [[ "$format" == "fawaz" ]]; then
            # fawazahmed0 æ ¼å¼è½‰æ›ï¼ˆéœ€è¦å°‡ {usd: {...}} è½‰ç‚º {rates: {...}}ï¼‰
            cat temp_rates.json | jq '{
              base: "USD",
              date: .date,
              rates: (.usd | to_entries | map({(.key | ascii_upcase): .value}) | add)
            }' > docs/rates.json
          fi

          rm temp_rates.json

          # é©—è­‰ TWD å­˜åœ¨
          if grep -q "TWD" docs/rates.json; then
            echo "âœ… TWD å·²ç¢ºèªå­˜åœ¨"
          else
            echo "âš ï¸ è­¦å‘Šï¼šTWD ä¸åœ¨è³‡æ–™ä¸­"
          fi

          # é¡¯ç¤ºå‰ 10 è¡Œä»¥ä¾›æª¢æŸ¥
          head -n 10 docs/rates.json

      - name: Commit and Push
        if: steps.check.outputs.should_update == 'true' && success()
        run: |
          git config --global user.name "Coinflow Bot"
          git config --global user.email "actions@github.com"

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if [[ -n $(git status -s docs/rates.json) ]]; then
            git add docs/rates.json
            git commit -m "Update exchange rates data (Source: ${{ steps.fetch.outputs.source }})"
            git push
            echo "âœ… åŒ¯ç‡å·²æ›´æ–°ä¸¦æ¨é€"
          else
            echo "â„¹ï¸ åŒ¯ç‡ç„¡è®ŠåŒ–"
          fi

      - name: Create Issue on Failure
        if: steps.check.outputs.should_update == 'true' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ åŒ¯ç‡æ›´æ–°å¤±æ•— (${now})`,
              body: `æ‰€æœ‰ API ä¾†æºéƒ½å¤±æ•—äº†ï¼Œè«‹æª¢æŸ¥ï¼š\n\n- open.er-api.com\n- fawazahmed0 CDN\n\næ™‚é–“ï¼š${now}`,
              labels: ['bug', 'automated', 'urgent']
            });

      # éƒ¨ç½²åˆ° GitHub Pages
      # é‚è¼¯ï¼šPush è§¸ç™¼æ™‚ç¸½æ˜¯éƒ¨ç½²ï¼›Rate æ›´æ–°æ™‚åªæœ‰æˆåŠŸæ‰éƒ¨ç½²
      - name: Setup Pages
        if: success() || steps.check.outputs.should_update == 'false'
        uses: actions/configure-pages@v4

      - name: Upload artifact
        if: success() || steps.check.outputs.should_update == 'false'
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

      - name: Deploy to GitHub Pages
        if: success() || steps.check.outputs.should_update == 'false'
        id: deployment
        uses: actions/deploy-pages@v4
