name: Update Exchange Rates

on:
  schedule:
    # 每天 UTC 時間 00:00 (台灣時間早上 08:00) 執行一次
    - cron: '0 0 * * *'
  # 允許手動按按鈕觸發 (方便測試)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create docs directory if not exists
        run: mkdir -p docs

      - name: Fetch Data from API
        id: fetch
        run: |
          # 使用 curl 下載資料到暫存檔 temp_rates.json
          # 這裡使用 frankfurter API (免費/無須Key)，以 USD 為基準
          curl -f -s "https://api.frankfurter.app/latest?from=USD" > temp_rates.json
          echo "Download complete."

      - name: Validate JSON (Parsing Check)
        id: validate
        run: |
          # 檢查下載下來的檔案是不是合法的 JSON
          if jq -e . temp_rates.json >/dev/null 2>&1; then
            echo "JSON validation passed."
          else
            echo "Error: Downloaded file is not valid JSON."
            cat temp_rates.json
            exit 1 
          fi

      - name: Process and Save Data
        run: |
          # 格式化並覆蓋正式檔案 (這裡才寫入 docs/rates.json)
          cat temp_rates.json | jq . > docs/rates.json
          rm temp_rates.json
          head -n 5 docs/rates.json

      - name: Commit and Push
        run: |
          git config --global user.name "CoinFlow Bot"
          git config --global user.email "actions@github.com"
          
          # 檢查是否有變更
          if [[ -n $(git status -s docs/rates.json) ]]; then
            git add docs/rates.json
            git commit -m "Update exchange rates data [skip ci]"
            git push
            echo "Rates updated successfully."
          else
            echo "No changes in exchange rates."
          fi
