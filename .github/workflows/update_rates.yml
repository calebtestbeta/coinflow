name: Update Exchange Rates

on:
  schedule:
    # 每天 UTC 時間 00:00 (台灣時間早上 08:00) 執行一次
    - cron: '0 0 * * *'
  # 允許手動按按鈕觸發 (方便測試)
  workflow_dispatch:

permissions:
  contents: write
  issues: write  # 需要建立 Issue 的權限

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create docs directory if not exists
        run: mkdir -p docs

      - name: Fetch Rates with Fallback
        id: fetch
        run: |
          # API 1: open.er-api.com（當前使用）
          echo "嘗試 API 1: open.er-api.com..."
          if curl -f -s --max-time 10 --retry 2 --retry-delay 2 \
            "https://open.er-api.com/v6/latest/USD" > temp_rates.json; then

            if jq -e '.base_code and .rates' temp_rates.json >/dev/null 2>&1; then
              echo "✅ API 1 成功"
              echo "source=open.er-api.com" >> $GITHUB_OUTPUT
              echo "format=openexchange" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # API 2: fawazahmed0 CDN（備援）
          echo "API 1 失敗，嘗試 API 2: fawazahmed0 CDN..."
          if curl -f -s --max-time 10 --retry 2 --retry-delay 2 \
            "https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json" > temp_rates.json; then

            if jq -e '.date and .usd' temp_rates.json >/dev/null 2>&1; then
              echo "✅ API 2 成功"
              echo "source=fawazahmed0" >> $GITHUB_OUTPUT
              echo "format=fawaz" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # 所有 API 都失敗
          echo "❌ 所有 API 都失敗"
          exit 1

      - name: Transform Data
        if: success()
        run: |
          source=${{ steps.fetch.outputs.source }}
          format=${{ steps.fetch.outputs.format }}

          if [[ "$format" == "openexchange" ]]; then
            # open.er-api.com 格式轉換
            cat temp_rates.json | jq '{
              base: .base_code,
              date: .time_last_update_utc[0:16],
              rates: .rates
            }' > docs/rates.json

          elif [[ "$format" == "fawaz" ]]; then
            # fawazahmed0 格式轉換（需要將 {usd: {...}} 轉為 {rates: {...}}）
            cat temp_rates.json | jq '{
              base: "USD",
              date: .date,
              rates: (.usd | to_entries | map({(.key | ascii_upcase): .value}) | add)
            }' > docs/rates.json
          fi

          rm temp_rates.json

          # 驗證 TWD 存在
          if grep -q "TWD" docs/rates.json; then
            echo "✅ TWD 已確認存在"
          else
            echo "⚠️ 警告：TWD 不在資料中"
          fi

          # 顯示前 10 行以供檢查
          head -n 10 docs/rates.json

      - name: Commit and Push
        if: success()
        run: |
          git config --global user.name "Coinflow Bot"
          git config --global user.email "actions@github.com"

          # 檢查是否有變更
          if [[ -n $(git status -s docs/rates.json) ]]; then
            git add docs/rates.json
            git commit -m "Update exchange rates (Source: ${{ steps.fetch.outputs.source }}) [skip ci]"
            git push
            echo "✅ 匯率已更新並推送"
          else
            echo "ℹ️ 匯率無變化"
          fi

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `⚠️ 匯率更新失敗 (${now})`,
              body: `所有 API 來源都失敗了，請檢查：\n\n- open.er-api.com\n- fawazahmed0 CDN\n\n時間：${now}`,
              labels: ['bug', 'automated', 'urgent']
            });
