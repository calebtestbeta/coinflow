name: Deploy and Update Rates

on:
  push:
    branches:
      - main
  schedule:
    # æ¯å¤© UTC æ™‚é–“ 00:00 (å°ç£æ™‚é–“æ—©ä¸Š 08:00) åŸ·è¡Œä¸€æ¬¡
    - cron: '0 0 * * *'
  # å…è¨±æ‰‹å‹•æŒ‰æŒ‰éˆ•è§¸ç™¼ (æ–¹ä¾¿æ¸¬è©¦)
  workflow_dispatch:
    inputs:
      update_rates:
        description: 'æ˜¯å¦æ›´æ–°åŒ¯ç‡ï¼Ÿ'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  issues: write    # éœ€è¦å»ºç«‹ Issue çš„æ¬Šé™
  pages: write     # éƒ¨ç½² GitHub Pages çš„æ¬Šé™
  id-token: write  # OIDC token æ¬Šé™

jobs:
  fetch-update-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Determine if should update rates
        id: check
        run: |
          # Cron è§¸ç™¼ï¼šä¸€å®šæ›´æ–°
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "ğŸ“… å®šæ™‚è§¸ç™¼ï¼šå°‡æ›´æ–°åŒ¯ç‡"

          # æ‰‹å‹•è§¸ç™¼ï¼šçœ‹ç”¨æˆ¶é¸æ“‡
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_update=${{ inputs.update_rates }}" >> $GITHUB_OUTPUT
            echo "ğŸ‘† æ‰‹å‹•è§¸ç™¼ï¼šæ›´æ–°åŒ¯ç‡ = ${{ inputs.update_rates }}"

          # Push è§¸ç™¼ï¼šä¸æ›´æ–°
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ ç¨‹å¼ç¢¼ Pushï¼šè·³éåŒ¯ç‡æ›´æ–°ï¼Œåƒ…éƒ¨ç½²"
          fi

      - name: Create docs directory if not exists
        if: steps.check.outputs.should_update == 'true'
        run: mkdir -p docs

      - name: Fetch Rates with Fallback
        if: steps.check.outputs.should_update == 'true'
        id: fetch
        run: |
          # API 1: open.er-api.comï¼ˆç•¶å‰ä½¿ç”¨ï¼‰
          echo "å˜—è©¦ API 1: open.er-api.com..."
          if curl -f -s --max-time 10 --retry 2 --retry-delay 2 \
            "https://open.er-api.com/v6/latest/USD" > temp_rates.json; then

            if jq -e '.base_code and .rates' temp_rates.json >/dev/null 2>&1; then
              echo "âœ… API 1 æˆåŠŸ"
              echo "source=open.er-api.com" >> $GITHUB_OUTPUT
              echo "format=openexchange" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # API 2: fawazahmed0 CDNï¼ˆå‚™æ´ï¼‰
          echo "API 1 å¤±æ•—ï¼Œå˜—è©¦ API 2: fawazahmed0 CDN..."
          if curl -f -s --max-time 10 --retry 2 --retry-delay 2 \
            "https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json" > temp_rates.json; then

            if jq -e '.date and .usd' temp_rates.json >/dev/null 2>&1; then
              echo "âœ… API 2 æˆåŠŸ"
              echo "source=fawazahmed0" >> $GITHUB_OUTPUT
              echo "format=fawaz" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # æ‰€æœ‰ API éƒ½å¤±æ•—
          echo "âŒ æ‰€æœ‰ API éƒ½å¤±æ•—"
          exit 1

      - name: Transform Data
        if: steps.check.outputs.should_update == 'true' && success()
        run: |
          source=${{ steps.fetch.outputs.source }}
          format=${{ steps.fetch.outputs.format }}

          if [[ "$format" == "openexchange" ]]; then
            # open.er-api.com æ ¼å¼è½‰æ›
            cat temp_rates.json | jq '{
              base: .base_code,
              date: .time_last_update_utc[0:16],
              rates: .rates
            }' > docs/rates.json

          elif [[ "$format" == "fawaz" ]]; then
            # fawazahmed0 æ ¼å¼è½‰æ›ï¼ˆéœ€è¦å°‡ {usd: {...}} è½‰ç‚º {rates: {...}}ï¼‰
            cat temp_rates.json | jq '{
              base: "USD",
              date: .date,
              rates: (.usd | to_entries | map({(.key | ascii_upcase): .value}) | add)
            }' > docs/rates.json
          fi

          rm temp_rates.json

          # é©—è­‰ TWD å­˜åœ¨
          if grep -q "TWD" docs/rates.json; then
            echo "âœ… TWD å·²ç¢ºèªå­˜åœ¨"
          else
            echo "âš ï¸ è­¦å‘Šï¼šTWD ä¸åœ¨è³‡æ–™ä¸­"
          fi

          # é¡¯ç¤ºå‰ 10 è¡Œä»¥ä¾›æª¢æŸ¥
          head -n 10 docs/rates.json

      - name: Fetch Crypto Rates with Triple Fallback
        if: steps.check.outputs.should_update == 'true'
        id: fetch_crypto
        run: |
          CRYPTO_IDS="bitcoin,ethereum,tether,binancecoin,solana,ripple,usd-coin,cardano,dogecoin,tron,matic-network,litecoin,polkadot,chainlink,avalanche-2"

          # API 1: CoinGecko Simple Priceï¼ˆä¸»è¦ä¾†æºï¼‰
          echo "å˜—è©¦ CoinGecko API..."
          if curl -f -s --max-time 15 --retry 2 --retry-delay 3 \
            "https://api.coingecko.com/api/v3/simple/price?ids=${CRYPTO_IDS}&vs_currencies=usd" \
            > temp_crypto.json; then

            if jq -e '.bitcoin.usd' temp_crypto.json >/dev/null 2>&1; then
              echo "âœ… CoinGecko API æˆåŠŸ"
              echo "crypto_source=coingecko" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # API 2: CryptoCompareï¼ˆå‚™æ´ï¼‰
          echo "CoinGecko å¤±æ•—ï¼Œå˜—è©¦ CryptoCompare..."
          SYMBOLS="BTC,ETH,USDT,BNB,SOL,XRP,USDC,ADA,DOGE,TRX,MATIC,LTC,DOT,LINK,AVAX"
          if curl -f -s --max-time 15 --retry 2 --retry-delay 3 \
            "https://min-api.cryptocompare.com/data/pricemulti?fsyms=${SYMBOLS}&tsyms=USD" \
            > temp_crypto.json; then

            if jq -e '.BTC.USD' temp_crypto.json >/dev/null 2>&1; then
              echo "âœ… CryptoCompare API æˆåŠŸ"
              echo "crypto_source=cryptocompare" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # API 3: Binanceï¼ˆå‚™æ´ï¼‰
          echo "CryptoCompare å¤±æ•—ï¼Œå˜—è©¦ Binance..."
          BINANCE_SYMBOLS='["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","TRXUSDT","MATICUSDT","LTCUSDT","DOTUSDT","LINKUSDT","AVAXUSDT"]'
          if curl -f -s --max-time 15 --retry 2 --retry-delay 3 \
            "https://api.binance.com/api/v3/ticker/price?symbols=${BINANCE_SYMBOLS}" \
            > temp_crypto.json; then

            if jq -e '.[0].price' temp_crypto.json >/dev/null 2>&1; then
              echo "âœ… Binance API æˆåŠŸ"
              echo "crypto_source=binance" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "âŒ æ‰€æœ‰åŠ å¯†è²¨å¹£ API éƒ½å¤±æ•—"
          exit 1

      - name: Transform Crypto Data
        if: steps.check.outputs.should_update == 'true' && steps.fetch_crypto.outcome == 'success'
        run: |
          SOURCE="${{ steps.fetch_crypto.outputs.crypto_source }}"
          TIMESTAMP=$(date -u +"%a, %d %b %Y")

          if [[ "$SOURCE" == "coingecko" ]]; then
            # CoinGecko æ ¼å¼è½‰æ›ï¼ˆé‡è¦ï¼šå–å€’æ•¸ä»¥åŒ¹é…æ³•å¹£æ ¼å¼ï¼‰
            cat temp_crypto.json | jq --arg date "$TIMESTAMP" '{
              base: "USD",
              date: $date,
              rates: {
                BTC: (if (.bitcoin.usd // 0) > 0 then 1 / .bitcoin.usd else 0 end),
                ETH: (if (.ethereum.usd // 0) > 0 then 1 / .ethereum.usd else 0 end),
                USDT: (if (.tether.usd // 1) > 0 then 1 / .tether.usd else 1 end),
                BNB: (if (.binancecoin.usd // 0) > 0 then 1 / .binancecoin.usd else 0 end),
                SOL: (if (.solana.usd // 0) > 0 then 1 / .solana.usd else 0 end),
                XRP: (if (.ripple.usd // 0) > 0 then 1 / .ripple.usd else 0 end),
                USDC: (if (."usd-coin".usd // 1) > 0 then 1 / ."usd-coin".usd else 1 end),
                ADA: (if (.cardano.usd // 0) > 0 then 1 / .cardano.usd else 0 end),
                DOGE: (if (.dogecoin.usd // 0) > 0 then 1 / .dogecoin.usd else 0 end),
                TRX: (if (.tron.usd // 0) > 0 then 1 / .tron.usd else 0 end),
                MATIC: (if (."matic-network".usd // 0) > 0 then 1 / ."matic-network".usd else 0 end),
                LTC: (if (.litecoin.usd // 0) > 0 then 1 / .litecoin.usd else 0 end),
                DOT: (if (.polkadot.usd // 0) > 0 then 1 / .polkadot.usd else 0 end),
                LINK: (if (.chainlink.usd // 0) > 0 then 1 / .chainlink.usd else 0 end),
                AVAX: (if (."avalanche-2".usd // 0) > 0 then 1 / ."avalanche-2".usd else 0 end)
              }
            }' > docs/crypto-rates.json

          elif [[ "$SOURCE" == "cryptocompare" ]]; then
            # CryptoCompare æ ¼å¼ï¼ˆè½‰æ›ç‚º "1 USD = X crypto" æ ¼å¼ï¼‰
            cat temp_crypto.json | jq --arg date "$TIMESTAMP" '{
              base: "USD",
              date: $date,
              rates: {
                BTC: (if (.BTC.USD // 0) > 0 then 1 / .BTC.USD else 0 end),
                ETH: (if (.ETH.USD // 0) > 0 then 1 / .ETH.USD else 0 end),
                USDT: (if (.USDT.USD // 1) > 0 then 1 / .USDT.USD else 1 end),
                BNB: (if (.BNB.USD // 0) > 0 then 1 / .BNB.USD else 0 end),
                SOL: (if (.SOL.USD // 0) > 0 then 1 / .SOL.USD else 0 end),
                XRP: (if (.XRP.USD // 0) > 0 then 1 / .XRP.USD else 0 end),
                USDC: (if (.USDC.USD // 1) > 0 then 1 / .USDC.USD else 1 end),
                ADA: (if (.ADA.USD // 0) > 0 then 1 / .ADA.USD else 0 end),
                DOGE: (if (.DOGE.USD // 0) > 0 then 1 / .DOGE.USD else 0 end),
                TRX: (if (.TRX.USD // 0) > 0 then 1 / .TRX.USD else 0 end),
                MATIC: (if (.MATIC.USD // 0) > 0 then 1 / .MATIC.USD else 0 end),
                LTC: (if (.LTC.USD // 0) > 0 then 1 / .LTC.USD else 0 end),
                DOT: (if (.DOT.USD // 0) > 0 then 1 / .DOT.USD else 0 end),
                LINK: (if (.LINK.USD // 0) > 0 then 1 / .LINK.USD else 0 end),
                AVAX: (if (.AVAX.USD // 0) > 0 then 1 / .AVAX.USD else 0 end)
              }
            }' > docs/crypto-rates.json

          elif [[ "$SOURCE" == "binance" ]]; then
            # Binance æ ¼å¼ï¼ˆè½‰æ›ç‚º "1 USD = X crypto" æ ¼å¼ï¼‰
            cat temp_crypto.json | jq --arg date "$TIMESTAMP" '{
              base: "USD",
              date: $date,
              rates: (
                reduce .[] as $item ({};
                  . + {
                    ($item.symbol | sub("USDT$"; "")): (
                      if (($item.price | tonumber) > 0)
                      then 1 / ($item.price | tonumber)
                      else 0
                      end
                    )
                  }
                )
              )
            }' > docs/crypto-rates.json
          fi

          rm temp_crypto.json

          # é©—è­‰é—œéµå¹£ç¨®
          for coin in BTC ETH USDT; do
            if grep -q "\"$coin\"" docs/crypto-rates.json; then
              echo "âœ“ $coin å·²ç¢ºèª"
            fi
          done

          # é¡¯ç¤ºå‰ 10 è¡Œä»¥ä¾›æª¢æŸ¥
          head -n 10 docs/crypto-rates.json

      - name: Commit and Push
        if: steps.check.outputs.should_update == 'true' && success()
        run: |
          git config --global user.name "Coinflow Bot"
          git config --global user.email "actions@github.com"

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          FIAT_CHANGED=$(git status -s docs/rates.json)
          CRYPTO_CHANGED=$(git status -s docs/crypto-rates.json)

          if [[ -n "$FIAT_CHANGED" || -n "$CRYPTO_CHANGED" ]]; then
            # æº–å‚™æäº¤è¨Šæ¯
            COMMIT_MSG="Update rates data"

            if [[ -n "$FIAT_CHANGED" && -n "$CRYPTO_CHANGED" ]]; then
              COMMIT_MSG="Update fiat & crypto rates (Sources: ${{ steps.fetch.outputs.source }}, ${{ steps.fetch_crypto.outputs.crypto_source }})"
              git add docs/rates.json docs/crypto-rates.json
            elif [[ -n "$FIAT_CHANGED" ]]; then
              COMMIT_MSG="Update fiat rates (Source: ${{ steps.fetch.outputs.source }})"
              git add docs/rates.json
            elif [[ -n "$CRYPTO_CHANGED" ]]; then
              COMMIT_MSG="Update crypto rates (Source: ${{ steps.fetch_crypto.outputs.crypto_source }})"
              git add docs/crypto-rates.json
            fi

            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… åŒ¯ç‡å·²æ›´æ–°ä¸¦æ¨é€"
          else
            echo "â„¹ï¸ åŒ¯ç‡ç„¡è®ŠåŒ–"
          fi

      - name: Create Issue on Failure
        if: steps.check.outputs.should_update == 'true' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            const fiatFailed = '${{ steps.fetch.outcome }}' === 'failure';
            const cryptoFailed = '${{ steps.fetch_crypto.outcome }}' === 'failure';

            let title = 'âš ï¸ åŒ¯ç‡æ›´æ–°å¤±æ•—';
            let body = 'åŒ¯ç‡æ›´æ–°éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼š\n\n';

            if (fiatFailed && cryptoFailed) {
              title = 'âš ï¸ æ³•å¹£èˆ‡åŠ å¯†è²¨å¹£åŒ¯ç‡æ›´æ–°å¤±æ•—';
              body += '**æ³•å¹£ API å¤±æ•—ï¼š**\n- open.er-api.com\n- fawazahmed0 CDN\n\n';
              body += '**åŠ å¯†è²¨å¹£ API å¤±æ•—ï¼š**\n- CoinGecko\n- CryptoCompare\n- Binance\n\n';
            } else if (fiatFailed) {
              title = 'âš ï¸ æ³•å¹£åŒ¯ç‡æ›´æ–°å¤±æ•—';
              body += '**æ³•å¹£ API å¤±æ•—ï¼š**\n- open.er-api.com\n- fawazahmed0 CDN\n\n';
            } else if (cryptoFailed) {
              title = 'âš ï¸ åŠ å¯†è²¨å¹£åŒ¯ç‡æ›´æ–°å¤±æ•—';
              body += '**åŠ å¯†è²¨å¹£ API å¤±æ•—ï¼š**\n- CoinGecko\n- CryptoCompare\n- Binance\n\n';
            } else {
              body += 'å…¶ä»–æ­¥é©Ÿå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ workflow æ—¥èªŒ\n\n';
            }

            body += `æ™‚é–“ï¼š${now}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${title} (${now})`,
              body: body,
              labels: ['bug', 'automated', 'urgent']
            });

      # éƒ¨ç½²åˆ° GitHub Pages
      # é‚è¼¯ï¼šPush è§¸ç™¼æ™‚ç¸½æ˜¯éƒ¨ç½²ï¼›Rate æ›´æ–°æ™‚åªæœ‰æˆåŠŸæ‰éƒ¨ç½²
      - name: Setup Pages
        if: success() || steps.check.outputs.should_update == 'false'
        uses: actions/configure-pages@v4

      - name: Upload artifact
        if: success() || steps.check.outputs.should_update == 'false'
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

      - name: Deploy to GitHub Pages
        if: success() || steps.check.outputs.should_update == 'false'
        id: deployment
        uses: actions/deploy-pages@v4
