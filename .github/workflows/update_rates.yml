name: Update Exchange Rates

on:
  schedule:
    # 每天 UTC 時間 00:00 (台灣時間早上 08:00) 執行一次
    - cron: '0 0 * * *'
  # 允許手動按按鈕觸發 (方便測試)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create docs directory if not exists
        run: mkdir -p docs

      - name: Fetch Data from API
        id: fetch
        run: |
          # 使用 curl 下載資料到暫存檔 temp_rates.json
          # 改用 open.er-api.com，因為它支援 TWD (台灣) 以及更多亞洲貨幣
          curl -f -s "https://open.er-api.com/v6/latest/USD" > temp_rates.json
          echo "Download complete."

      - name: Validate JSON (Parsing Check)
        id: validate
        run: |
          # 檢查下載下來的檔案是不是合法的 JSON
          if jq -e . temp_rates.json >/dev/null 2>&1; then
            echo "JSON validation passed."
          else
            echo "Error: Downloaded file is not valid JSON."
            cat temp_rates.json
            exit 1 
          fi

      - name: Process and Save Data
        run: |
          # 格式化並覆蓋正式檔案 (這裡才寫入 docs/rates.json)
          # 使用 jq 轉換欄位名稱以符合我們 App 的需求：
          # 1. .base_code -> .base
          # 2. .time_last_update_utc -> .date (擷取前 16 個字元當作日期顯示)
          # 3. .rates -> .rates (確保包含 TWD)
          cat temp_rates.json | jq '{base: .base_code, date: .time_last_update_utc[0:16], rates: .rates}' > docs/rates.json
          
          rm temp_rates.json
          
          # 確認輸出的內容包含 TWD
          echo "Checking for TWD..."
          grep -o "TWD" docs/rates.json || echo "Warning: TWD not found in response"
          
          head -n 10 docs/rates.json

      - name: Commit and Push
        run: |
          git config --global user.name "CoinFlow Bot"
          git config --global user.email "actions@github.com"
          
          # 檢查是否有變更
          if [[ -n $(git status -s docs/rates.json) ]]; then
            git add docs/rates.json
            git commit -m "Update exchange rates data (Added TWD support) [skip ci]"
            git push
            echo "Rates updated successfully."
          else
            echo "No changes in exchange rates."
          fi